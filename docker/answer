#!/usr/bin/env python3
# -*- coding:utf8 -*-
import sys
import pandas as pd
import math
from processor.stanza_process import StanzaProcessor
from ans.how_what_why_answer import HowWhatWhyAnswer
from ans.who_when_where_answer import WhoWhenWhereAnswer
from ans.yes_no_answer import YesNoAnswer


class Answer:
    def __init__(self, article, questions):
        self.questions = questions
        self.article = article
        self.answers = []
    
    def find_sentence(self, question, article):
        """
            TODO: find the sentence in article
                ideas: using tf-idf, cosine similarity... 
        """
        # using tf-idf
        # Define data and preprocessing
        bow = article.split(" ")
        wordSet = set(bow)

        # Counting the number of words
        wordDict = dict.fromkeys(wordSet, 0)
        for word in bow:
            wordDict[word] += 1

        # just showing the correctness of this part of function
        pd.DataFrame(wordDict)

        # computing TF
        tfDict = {}
        nbowCount = len(bow)

        for word, count in wordDict.items():
            tfDict[word] = count / nbowCount

        # computing IDF
        idfDict = dict.fromkeys(wordDict)
        for word, count in wordDict.items():
            if count > 0:
                idfDict[word] += 1
        for word, ni in idfDict.items():
            idfDict[word] = math.log10((3)/(ni + 1))

        # computing TF-IDF
        tfidf = {}
        for word, tfval in tfDict.items():
            tfidf[word] = tfval * idfDict[word]
        # just showing the correctness of this part of function
        pd.DataFrame(tfidf)

        return tfidf
    
    def classify_and_answer(self, question, sentence):
        """
            TODO: classify question into different types using leading word
            then process the sentence using libraries

                Binary: Is/are/was/were/did/do/does/has/had/have...
                    - 我们可以先用随机来回答binary问题，后面再进一步改动
            --------------
                Who/Whom    NER Person
                When        NER Date
                Where       NER Location
            ---------------
                What/Which
                    - is/are..  
                    - else      
                How
                    - is/are..  
                    - many/much
                    - else      
                Why
        """
        processed_sentence = StanzaProcessor(sentence=sentence)
        processed_sentence.process()
        processed_sentence = processed_sentence.sentences[0]
        processed_question = StanzaProcessor(sentence=question)
        processed_question.process()
        processed_question = processed_question.sentences[0]

        first_word = processed_question.sentences[0].words[0].text.lower()
        if first_word == 'what' or first_word == 'which':
            return HowWhatWhyAnswer(processed_sentence, processed_question).what()
        elif first_word == 'how':
            return HowWhatWhyAnswer(processed_sentence, processed_question).how()
        elif first_word == 'why':
            return HowWhatWhyAnswer(processed_sentence, processed_question).why()
        elif first_word == 'who' or first_word == 'whom':
            return WhoWhenWhereAnswer(processed_sentence, processed_question).who()
        elif first_word == 'when':
            return WhoWhenWhereAnswer(processed_sentence, processed_question).when()
        elif first_word == 'where':
            return WhoWhenWhereAnswer(processed_sentence, processed_question).where()
        else:
            return YesNoAnswer(processed_sentence, processed_question).answer()
    
    def generate(self):
        for question in self.questions:
            
            sentence = self.find_sentence(question, self.article)
            answer = self.classify_and_answer(question, sentence)
            self.answers.append(answer)

            # for testing
            print(answer)

    

if __name__ == "__main__":
    article = sys.argv[1]
    question_file = sys.argv[2]
    questions = []
    with open(question_file, 'r') as f:
        count = 0
        for line in f:
            count += 1
            questions.append(line.strip())
    answer = Answer(article, questions)
    answer.generate()
